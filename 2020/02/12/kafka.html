<!DOCTYPE HTML><title>Bob’s Blog</title><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/html5shiv/3.6.2/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/main.css" /> <!--[if lte IE 9]><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/ie9.css" /><![endif]--> <!--[if lte IE 8]><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/ie8.css" /><![endif]--> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?62888767648ab0a78f7107ed1f6dc242"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script src='//unpkg.com/valine/dist/Valine.min.js'></script><body oncontextmenu="return false;" onselectstart="return false"><div id="wrapper"><header id="header"><h1><a href="/index.html">記憶 備份</a></h1><nav class="links"><ul><li><a href="/#about">關於我</a></ul></nav><nav class="main"><ul><li class="light"> <input type="checkbox" class="checke"><li class="menu"> <a class="fa-bars" href="#menu">Menu</a></ul></nav></header><section id="menu"><section> <form class="search" method="get" action="#"> <input type="text" name="query" placeholder="Search" id="search-input" /> </form></section><section><div id="results-container"></div></section></section><div id="main"><article class="post"><h1 id="kafka">Kafka</h1><hr /><h3 id="磁盘存储结构">磁盘存储结构</h3><ul><li>topic<ul><li>partition<ul><li>segment<ul><li>.index<li>.log<li>.timeindex<li>leader-epoch-checkpoint ***<h3 id="消息同步机制">消息同步机制</h3></ul></ul></ul><li>副本半数以上<li>全部同步完成<ul><li>ISR<ul><li>给定范围内重新选主机制<ul><li>同步条数判断优先级，条数越多，优先级越大（已过时，频繁操作zk）<li>时间延迟判断优先级，延迟越低，优先级越大</ul></ul></ul><li>数据安全性（丢失）<ul><li>0：不等待ack<li>1：等待leader节点同步完成即可<li>-1：等待全部ISR中节点同步完成</ul><li>数据一致性<ul><li>HW(High Watermark)<ul><li>副本中同步最少的偏移量（Consumer可见的最大偏移量）</ul><li>LEO(Log End Offset)<ul><li>副本同步的最新的偏移量</ul></ul><li>幂等性（去重复）<ul><li>enable.idompotence=true<li>只保证相同会话的一次写入，如果producer重新连接，PID会被重新分配<li>ack=-1<li>Broker对&lt;PID,Partition,SeqNumber&gt;做缓存，过滤重复 ***<h3 id="消费策略">消费策略</h3></ul><li>消息轮询 RoundRobin：按组划分<li>消息分段 Range：按主题划分<li>offset<ul><li>&lt;group-id,topic,partition&gt;确定一个offset<li>存储结构<ul><li>zookeeper(0.9之前版本)<ul><li>get /consumers/consumer-<group-id>/offsets/<topics>/<partitions>/<offset></offset></partitions></topics></group-id></ul><li>kafka(0.9版本开始)<ul><li> <__consumer_offsets> </__consumer_offsets><li>kafka-topics.sh –describe –topic __consumer_offsets –zookeeper zoo1:2181 ***<h3 id="高效读写">高效读写</h3></ul></ul></ul><li>分区并发<li>顺序写磁盘<li>零拷贝<ul><li>用户空间和内核空间的拷贝 =&gt; transfer ***<h3 id="broker主节点">Broker主节点</h3></ul><li>zookeeper<ul><li>get /controller ***<h3 id="事务">事务</h3></ul><li>0.11版本之后支持<li>Producer<ul><li>Transaction Coordinator<ul><li>TransactionID</ul></ul><li>配合幂等性，ack=-1，事务可达到跨分区跨会话 ***<h3 id="发送消息流程">发送消息流程</h3><li>Producer<li>Interceptors<li>Serializer<li>Partitioner<li>RecordAccumulator</ul><hr /><h3 id="topic">topic</h3><ul><li>create topic<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kafka-topics.sh --create --zookeeper zoo1:2181 --replication-factor 1 --partitions 3 --topic book
</code></pre></div></div><li>list topic ``` kafka-topics.sh –zookeeper zoo1:2181 –list</ul><h1 id="describe">describe</h1><p>kafka-topics.sh –describe –topic book –zookeeper zoo1:2181</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- delete topic
</code></pre></div></div><p>kafka-topics.sh –delete –zookeeper zoo1:2181 –topic book</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### producer
- console-producer
</code></pre></div></div><p>kafka-console-producer.sh –broker-list localhost:9092 –topic book</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### consumer
- console-consumer
</code></pre></div></div><p>kafka-console-consumer.sh –bootstrap-server localhost:9092 –topic book –from-beginning kafka-console-consumer.sh –bootstrap-server localhost:9092 –topic book –from-beginning –group test_group ```</p></article><div id="vcomments"></div><ul class="actions pagination"><li><a title="Spring" href="/spring/2020/02/11/spring.html" class="button big previous">Previous</a><li><a title="MongoDB" href="/2020/02/12/mongodb.html" class="button big next">Next</a><li id="/2020/02/12/kafka.html" class="leancloud_visitors" style="float: right;"><a class="icon fa-eye leancloud-visitors-count" aria-hidden="true"></a></ul></div><script> new Valine({ el: '#vcomments' , appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc', notify:false, verify:false, avatar:'mp', placeholder: '若有疏失，還望指正', visitor: true, recordIP: true }); </script></div><div id="leftsead"><ul><li class="top"> ↑<li class="bottom"> ↑</ul></div><script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script> <script src="https://cdn.bootcss.com/skel/3.0.0/skel.min.js"></script> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script><![endif]--> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/main.js"></script> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/util.js"></script> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/search.js"></script> <script> new Valine({ el: '#vcomments', appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc' }) </script>
