<!DOCTYPE HTML><title>Bob’s Blog</title><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/html5shiv/3.6.2/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/main.css" /> <!--[if lte IE 9]><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/ie9.css" /><![endif]--> <!--[if lte IE 8]><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/css/ie8.css" /><![endif]--> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?62888767648ab0a78f7107ed1f6dc242"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script src='//unpkg.com/valine/dist/Valine.min.js'></script><body oncontextmenu="return false;" onselectstart="return false"><div id="wrapper"><header id="header"><h1><a href="/index.html">記憶 備份</a></h1><nav class="links"><ul><li><a href="/#about">關於我</a></ul></nav><nav class="main"><ul><li class="light"> <input type="checkbox" class="checke"><li class="menu"> <a class="fa-bars" href="#menu">Menu</a></ul></nav></header><section id="menu"><section> <form class="search" method="get" action="#"> <input type="text" name="query" placeholder="Search" id="search-input" /> </form></section><section><div id="results-container"></div></section></section><div id="main"><article class="post"><h1 id="mysql">Mysql</h1><hr /><h3 id="性能監控指标">性能監控指标</h3><ul><li>QPS<ul><li>queries per second 每秒查询数量<li><code class="highlighter-rouge">show global status like 'Question%';</code><li>QPS = queries/seconds</ul><li>TPS<ul><li>Transaction per second<li><code class="highlighter-rouge">show global status like 'Com_commit';</code><li><code class="highlighter-rouge">show global status like 'Com_rollback';</code><li>TPS = (Com_commit + Com_rollback)/seconds</ul><li>连接数<ul><li><code class="highlighter-rouge">show global status like 'Max_used_connections';</code><li><code class="highlighter-rouge">show global status like 'Threads%';</code><li><code class="highlighter-rouge">show variables like 'max_connections';</code></ul><li>Query Cache<ul><li>數據改動較少場景<li>my.cnf參數修改 <code class="highlighter-rouge">query_cache_size</code><li><code class="highlighter-rouge">show status like 'Qcache%';</code><li>Query_cache_hits = (Qcache_hits/(Qcache_hits+Qcache_inserts)) * 100%</ul><li>Lock<ul><li><code class="highlighter-rouge">show global status like '%lock%';</code><li>Table_locks_waited/Table_locks_immediate 值越大表示鎖造成的阻塞越嚴重<li>Innodb 中間隙鎖造成 Innodb_row_lock_waits 太大</ul><li>主從延時<ul><li><code class="highlighter-rouge">show slave status;</code></ul><li>慢查詢<ul><li>my.cnf參數修改 [mysqld] <code class="highlighter-rouge">slow_query_log=1</code><li>慢查詢日志地址<code class="highlighter-rouge">slow_query_log_file=/data/mysql/slow.log</code><li>慢查詢時長<code class="highlighter-rouge">long_query_time=1</code><li>未使用索引的查詢 <code class="highlighter-rouge">log_queries_not_using_indexes=1</code><li><code class="highlighter-rouge">mysqldumpslow -s c -t 10 slow.log</code> # 返回使用最多的10條<li><code class="highlighter-rouge">mysqldumpslow -s r -t 10 slow.log</code> # 返回結果最多的10條</ul></ul><hr /><hr /><ul><li>索引类型<ul><li>聚集索引（主键索引）：按照每张表的主键构造一颗B+树，同时叶子节点中存放的即为整张表的记录数据<li>辅助索引（二级索引）：叶子节点中存储主键值（聚集索引），每次查找数据时，根据索引找到叶子节点中的主键值，根据主键值再到聚簇索引中得到完整的一行记录<li>覆盖索引：非聚集索引有二次（回表）查询的问题，所以使用索引包含了查询正在查找的所有数据（组合索引）<li>普通索引：change buffer<li>唯一索引<li><h2 id="外键索引">外键索引</h2></ul><li>分区表 partition<ul><li>逻辑结构表现为同一个表，物理结构为多个索引文件.ibd<li>分区算法<ul><li>hash 取模<li>range<li>list</ul><li>约束<ul><li>具有主键或唯一索引的表，主键或唯一索引必须是分区键的一部分</ul><li>分区信息查询<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">table_name</span><span class="p">,</span><span class="n">partition_name</span><span class="p">,</span><span class="n">partition_description</span><span class="p">,</span><span class="n">table_rows</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="nv">`PARTITIONS`</span>
</code></pre></div></div><li>创建分区表<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="n">hash</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="k">type</span><span class="o">&gt;</span> <span class="p">...)</span> 
<span class="n">partition</span> <span class="k">by</span> <span class="n">hash</span><span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">partitions</span> <span class="mi">6</span><span class="p">;</span>
<span class="o">#</span> <span class="n">range</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="k">type</span><span class="o">&gt;</span> <span class="p">...)</span> 
<span class="n">partition</span> <span class="k">by</span> <span class="n">range</span><span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span>
  <span class="n">partition</span> <span class="n">p0</span> <span class="k">values</span> <span class="k">less</span> <span class="k">than</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span>
  <span class="n">partition</span> <span class="n">p1</span> <span class="k">values</span> <span class="k">less</span> <span class="k">than</span><span class="p">(</span><span class="mi">20000</span><span class="p">),</span>
  <span class="n">partition</span> <span class="n">p2</span> <span class="k">values</span> <span class="k">less</span> <span class="k">than</span> <span class="k">MAXVALUE</span>
<span class="p">);</span>
<span class="o">#</span> <span class="n">list</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="k">type</span><span class="o">&gt;</span> <span class="p">...)</span> 
<span class="n">partition</span> <span class="k">by</span> <span class="n">list</span><span class="p">(</span><span class="o">&lt;</span><span class="n">field_name</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span>
  <span class="n">partition</span> <span class="n">p0</span> <span class="k">values</span> <span class="k">in</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
  <span class="n">partition</span> <span class="n">p1</span> <span class="k">values</span> <span class="k">in</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="p">);</span>
    
</code></pre></div></div><li>增加分区<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="k">add</span> <span class="n">partition</span><span class="p">(</span><span class="n">partition</span> <span class="o">&lt;</span><span class="n">partition_name</span><span class="o">&gt;</span> <span class="k">values</span> <span class="k">less</span> <span class="k">than</span><span class="p">(</span><span class="mi">2020</span><span class="p">));</span>
</code></pre></div></div><li>删除分区<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="k">drop</span> <span class="n">partition</span> <span class="o">&lt;</span><span class="n">partition_name</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div><li>迁移分区数据(version&gt;=5.7)<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="o">&lt;</span><span class="k">table_name</span><span class="o">&gt;</span> <span class="n">exchange</span> <span class="n">partition</span> <span class="o">&lt;</span><span class="n">partition_name</span><span class="o">&gt;</span> <span class="k">with</span> <span class="k">table</span> <span class="o">&lt;</span><span class="n">target_archive_table_name</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">#</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">ARCHIVE</span> <span class="err">使迁移的目标表只读</span>
</code></pre></div></div><hr /></ul><li>分库分表</ul><h3 id="jmeter配置">Jmeter配置</h3></article><div id="vcomments"></div><ul class="actions pagination"><li><a title="Java相關總結" href="/java/2020/02/10/interview.html" class="button big previous">Previous</a><li><a title="Netty" href="/netty/2020/02/11/netty.html" class="button big next">Next</a><li id="/mysql/2020/02/11/mysql.html" class="leancloud_visitors" style="float: right;"><a class="icon fa-eye leancloud-visitors-count" aria-hidden="true"></a></ul></div><script> new Valine({ el: '#vcomments' , appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc', notify:false, verify:false, avatar:'mp', placeholder: '若有疏失，還望指正', visitor: true, recordIP: true }); </script></div><div id="leftsead"><ul><li class="top"> ↑<li class="bottom"> ↑</ul></div><script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script> <script src="https://cdn.bootcss.com/skel/3.0.0/skel.min.js"></script> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script><![endif]--> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/main.js"></script> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/util.js"></script> <script src="https://cdn.jsdelivr.net/gh/hizhangbo/hizhangbo.github.io@v0.1/assets/js/search.js"></script> <script> new Valine({ el: '#vcomments', appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc' }) </script>
