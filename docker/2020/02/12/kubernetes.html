<!DOCTYPE HTML><title>Bob’s Blog</title><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/html5shiv/3.6.2/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="/assets/css/main.css" /> <!--[if lte IE 9]><link rel="stylesheet" href="/assets/css/ie9.css" /><![endif]--> <!--[if lte IE 8]><link rel="stylesheet" href="/assets/css/ie8.css" /><![endif]--> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?62888767648ab0a78f7107ed1f6dc242"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> <script src='//unpkg.com/valine/dist/Valine.min.js'></script><body oncontextmenu="return false;" onselectstart="return false"><div id="wrapper"><header id="header"><h1><a href="/index.html">記憶 備份</a></h1><nav class="links"><ul><li><a href="/#about">關於我</a></ul></nav><nav class="main"><ul><li class="light"> <input type="checkbox" class="checke"><li class="menu"> <a class="fa-bars" href="#menu">Menu</a></ul></nav></header><section id="menu"><section> <form class="search" method="get" action="#"> <input type="text" name="query" placeholder="Search" id="search-input" /> </form></section><section><div id="results-container"></div></section></section><div id="main"><article class="post"><h1 id="kubernetes">Kubernetes</h1><hr /><h3 id="安裝部署">安裝部署</h3><ol><li>kubeadm 环境准备 ```shell sysctemctl stop firewalld &amp;&amp; sysctemctl disable firewalld yum install -y docker systemctl enable docker &amp;&amp; systemctl start docker</ol><h1 id="重启后失效">重启后失效</h1><p>swapoff -a</p><h1 id="要永久禁掉swap分区打开如下文件注释掉swap那一行">要永久禁掉swap分区，打开如下文件注释掉swap那一行</h1><p>vim /etc/fstab</p><h1 id="rhel--centos-7上的一些用戶報告了由於iptables被繞過而導致流量路由不正確的問題您應該確保-netbridgebridge-nf-call-iptables在sysctl配置中設置為1">RHEL / CentOS 7上的一些用戶報告了由於iptables被繞過而導致流量路由不正確的問題。您應該確保 net.bridge.bridge-nf-call-iptables在sysctl配置中設置為1</h1><p>cat «EOF &gt; /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF sysctl –system</p><h1 id="正式开始安装">正式开始安装</h1><p>cat «EOF &gt; /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgcheck=1 repo_gpgcheck=1</p><h1 id="切换阿里环境">切换阿里环境</h1><h1 id="gpgkeyhttpsmirrorsaliyuncomkubernetesyumdocyum-keygpg">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</h1><p>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg EOF</p><h1 id="set-selinux-in-permissive-mode-effectively-disabling-it">Set SELinux in permissive mode (effectively disabling it)</h1><h1 id="安全增强型-linuxsecurity-enhanced-linux简称-selinux-主要作用就是最大限度地减小系统中服务进程可访问的资源最小权限原则">安全增强型 Linux(Security-Enhanced Linux)简称 SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源(最小权限原则)</h1><p>/usr/sbin/sestatus -v # 查看SELinux状态</p><h1 id="关闭-selinux-权限限制">关闭 SELinux 权限限制</h1><h1 id="第一种方式临时关闭不需要重启机器">第一种方式临时关闭，不需要重启机器</h1><p>setenforce 0</p><h1 id="第二种方式修改配置文件">第二种方式修改配置文件</h1><p>sed -i ‘s/^SELINUX=enforcing$/SELINUX=permissive/’ /etc/selinux/config</p><p>yum install -y kubelet kubeadm kubectl –disableexcludes=kubernetes systemctl enable –now kubelet</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  2. 配置ssh免密码访问
```shell
-- 修改hostname
hostnamectl --static set-hostname  kuber-master

ssh -o "StrictHostKeyChecking no" root@123456
ssh-keygen
ssh-copy-id -i ~/.ssh/id_rsa.pub root@kube1
ssh-copy-id -i ~/.ssh/id_rsa.pub root@kube2
</code></pre></div></div><ol><li>初始化master节点 ```shell<h1 id="下载镜像">下载镜像</h1><p>kubeadm config images list kubeadm config images pull</p></ol><h1 id="k8sgcriokube-apiserverv1153">k8s.gcr.io/kube-apiserver:v1.15.3</h1><h1 id="k8sgcriokube-controller-managerv1153">k8s.gcr.io/kube-controller-manager:v1.15.3</h1><h1 id="k8sgcriokube-schedulerv1153">k8s.gcr.io/kube-scheduler:v1.15.3</h1><h1 id="k8sgcriokube-proxyv1153">k8s.gcr.io/kube-proxy:v1.15.3</h1><h1 id="k8sgcriopause31">k8s.gcr.io/pause:3.1</h1><h1 id="k8sgcrioetcd3310">k8s.gcr.io/etcd:3.3.10</h1><h1 id="k8sgcriocoredns131">k8s.gcr.io/coredns:1.3.1</h1><p>kubeadm init –kubernetes-version=v1.15.3 –pod-network-cidr=10.244.0.0/16</p><p>kubeadm join 192.168.127.70:6443 –token t0xrfm.n1cpx8k1g84e7u8u <br /> –discovery-token-ca-cert-hash sha256:49772aa397f90e5d06d0c02e080156cdd740930d0fa3f371f2dcd87790dce568</p><h1 id="配置普通用户可以运行-kubectl-命令">配置普通用户可以运行 kubectl 命令</h1><h1 id="root-账号执行">root 账号执行</h1><p>export KUBECONFIG=/etc/kubernetes/admin.conf</p><h1 id="普通账号执行">普通账号执行</h1><p>mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  4. 安装pod網絡加載項
```shell
# For flannel to work correctly, you must pass --pod-network-cidr=10.244.0.0/16 to kubeadm init
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/62e44c867a2846fefb68bd5f178daf4da3095ccb/Documentation/kube-flannel.yml

# For Calico to work correctly, you need to pass --pod-network-cidr=192.168.0.0/16 to kubeadm init
kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml
</code></pre></div></div><ol><li>安装dashboard<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta3/aio/deploy/recommended.yaml
kubectl proxy <span class="nt">--address</span> 0.0.0.0 <span class="nt">--accept-hosts</span> <span class="s1">'.*'</span>
kubectl proxy
</code></pre></div></div></ol><hr /><h3 id="常用命令">常用命令</h3><ul><li>kubeadm<ol><li>kubeadm token create # 令牌在24小時後過期,<li>kubeadm token list</ol><li>kubectl<ol><li>kubectl version # 查看Kubernetes集群和客户端版本<li>kubectl api-versions # 查看api版本 group/version<li>kubectl get pods –all-namespaces # 获取所有 pod<li>kubectl get nodes # 获取所有集群节点<li>kubectl cluster-info # 获取集群信息<li>从集群中移除节点<ol><li>kubectl drain <node name=""> --delete-local-data --force --ignore-daemonsets # 主节点上运行</node><li>kubectl delete node <node name=""> # 主节点上运行</node><li>kubeadm reset # 在要刪除的節點上，重置所有kubeadm安裝狀態</ol><li>kubectl describe nodes kube0 # 获取单个节点描述<li>kubectl describe pods etcd-kube0 -n kube-system # 获取单个pod描述<li>kubectl get deployment coredns -n kube-system # 查看部署的pod集群状态<li>kubectl get deployment coredns -n kube-system -o yaml # 查看部署时的yaml描述<li>kubectl edit service kubernetes-dashboard -n kubernetes-dashboard # 编辑部署时的yaml描述<li>kubectl get service kubernetes-dashboard -n kubernetes-dashboard<li>kubectl get pod kubernetes-dashboard-7d8b9cc8d-fz5qz -n kubernetes-dashboard -o wide<li>kubectl get pod kubernetes-dashboard-7d8b9cc8d-fz5qz -n kubernetes-dashboard -o yaml<li>kubectl get svc –all-namespaces # service<li>kubectl get rc –all-namespaces # ReplicaController<li>kubectl get rs –all-namespaces # ReplicaSet<li>kubectl expose pods kubernetes-dashboard-7d8b9cc8d-fz5qz –type=NodePort -n kubernetes-dashboard # 暴露服务端口到外部<li>kubectl delete service kubernetes-dashboard-7d8b9cc8d-fz5qz -n kubernetes-dashboard # 删除创建的服务<li>kubectl get node –show-labels # 显示标签<li>kubectl label node kube1 label:value # 设置标签<li>kubectl get namespaces<li>kubectl logs dashboard-metrics-scraper-fb986f88d-2266s -n kubernetes-dashboard # 打印日志<li>kubectl exec<li>kubectl patch svc kubernetes-dashboard -p ‘{“spec”:{“type”:”NodePort”}}’ -n kubernetes-dashboard # 以打补丁方式修改dasboard的访问方式<li>kubectl get secret -n kubernetes-dashboard # 获取身份认证服务<li>kubectl describe secret kubernetes-dashboard-token-wl8wl -n kubernetes-dashboard # 获取登录token<li>kubectl get sa –all-namespaces # 获取serviceAccount<li>kubectl get role –all-namespaces # 获取集群角色<li>kubectl get clusterrolebinding # 获取集群角色绑定<li>kubectl describe clusterrolebinding cluster-admin # 角色绑定详情描述<li>kubectl describe role kubernetes-dashboard -n kubernetes-dashboard # 获取角色详情<li>kubectl describe clusterrole cluster-admin -n kube-system # 获取集群角色详情<li>kubectl create clusterrolebinding kubernetes-dashboard-admin –clusterrole=cluster-admin –serviceaccount=kubernetes-dashboard:kubernetes-dashboard # 绑定serviceaccount和clusterrole, namespace:name<li>kubectl describe secret kubernetes-dashboard-token-wl8wl -n kubernetes-dashboard # 获取集群权限token</ol></ul><hr /><h3 id="問題解決">問題解決</h3><ol><li>coredns 启动失败 ```shell kubectl get deployment coredns -n kube-system -o yaml | <br /> sed ‘s/allowPrivilegeEscalation: false/allowPrivilegeEscalation: true/g’ | <br /> kubectl apply -f -</ol><p>似乎有3種不同的解決方法：</p><p>升級到更新版本的docker，例如17.03，k8s目前推薦的版本 或者從部署的pod規範中刪除allowPrivilegeEscalation = false 或者禁用SELinux</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# 其它资料
[Kubernetes部署](https://yq.aliyun.com/articles/682810 "利用 Kubeadm部署 Kubernetes 1.13.1 集群实践录")  
[Dashboard安装](https://andrewpqc.github.io/2018/04/24/setup-k8s-dashboard-on-cluster "Dashboard生成SSL安全证书")

1. VMware安装一台centos7，并安装docker  
2. 拷贝多份虚拟机，并为每一台修改 host  
```shell
hostnamectl --static set-hostname  kuber-master  
hostnamectl --static set-hostname  kuber-slave1  
hostnamectl --static set-hostname  kuber-slave2  
</code></pre></div></div><ol><li>修改ifcfg-env hosts 文件，并重启网络 service restart network<li>硬件限制<br /> 每台机器2 GB或更多的RAM（任何更少的内存将为您的应用留下很小的空间） 2个CPU或更多<br /> [ERROR NumCPU]: the number of available CPUs 1 is less than the required 2<br /> kubeadm init –kubernetes-version=v1.13.1 –pod-network-cidr=10.244.0.0/16 –ignore-preflight-errors=NumCPU<br /> error execution phase wait-control-plane: couldn’t initialize a Kubernetes cluster<li>no set 1 error<br /> 将命令echo “1” &gt; /proc/sys/net/ipv4/ip_forward 写入脚本/etc/rc.d/rc.local<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"1"</span> <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward  
<span class="nb">echo</span> <span class="s2">"1"</span> <span class="o">&gt;</span> /proc/sys/net/bridge/bridge-nf-call-iptables
</code></pre></div></div><li>查看占用端口进程<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>net-tools  
netstat <span class="nt">-tunlp</span>|grep port  
</code></pre></div></div><li>安装 ``` curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl</ol><p>chmod +x ./kubectl</p><p>sudo mv ./kubectl /usr/local/bin/kubectl</p><p>kubectl version</p><p>https://kubernetes.io/docs/tasks/tools/install-kubectl/</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>8. 查看状态(STATUS:ContainerCreating)  
```shell
kubectl get pods --all-namespaces -o wide  
</code></pre></div></div><ol><li>容器详细描述<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe node server0  
</code></pre></div></div><li>对于swap的限制<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 重启后失效</span>
swapoff <span class="nt">-a</span>   
<span class="c"># 要永久禁掉swap分区，打开如下文件注释掉swap那一行 </span>
vim /etc/fstab
</code></pre></div></div><li>删除pod<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete pod NAME <span class="nt">--grace-period</span><span class="o">=</span>0 <span class="nt">--force</span>  
</code></pre></div></div><li>Dashboard访问密钥<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create secret generic kubernetes-dashboard-certs <span class="nt">--from-file</span><span class="o">=</span>/home/share/certs <span class="nt">-n</span> kube-system  
</code></pre></div></div><li>生成token<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe secret/<span class="si">$(</span>kubectl get secret <span class="nt">-nkube-system</span> |grep admin|awk <span class="s1">'{print $1}'</span><span class="si">)</span> <span class="nt">-nkube-system</span>  
</code></pre></div></div><li>kubectl命令自动补全<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> bash-completion
<span class="nb">source</span> /usr/share/bash-completion/bash_completion
<span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>  
</code></pre></div></div><li>删除deployment<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get deployments  
kubectl delete deployments <span class="o">[</span>NameOfDeployment]  
kubectl get rc
kubectl delete deployments <span class="o">[</span>NameOfrc]  
</code></pre></div></div><li>登录aliyun 镜像仓库<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login registry.cn-shenzhen.aliyuncs.com/hizhangbo/test <span class="nt">-u</span><span class="o">=[</span>account <span class="nb">id</span><span class="o">]</span>  
</code></pre></div></div><li>kompose安装<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Linux</span>
curl <span class="nt">-L</span> https://github.com/kubernetes/kompose/releases/download/v1.18.0/kompose-linux-amd64 <span class="nt">-o</span> kompose
<span class="nb">chmod</span> +x kompose
<span class="nb">sudo mv</span> ./kompose /usr/local/bin/kompose
<span class="c"># autocomplete</span>
<span class="c"># Bash (add to .bashrc for persistence)</span>
<span class="nb">source</span> &lt;<span class="o">(</span>kompose completion bash<span class="o">)</span>
</code></pre></div></div><li>本地调试<br /> <em><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/local-debugging/" title="kubernetes官网">kubernetes官网</a></em><br /> <em><a href="https://www.telepresence.io/" title="telepresence官网">telepresence官网</a></em><br /> <em><a href="https://kubernetes.io/zh/docs/setup/independent/install-kubeadm/" title="kubeadm安装文档">kubeadm安装文档</a></em></ol></article><div id="vcomments"></div><ul class="actions pagination"><li><a title="Spring" href="/spring/2020/02/11/spring.html" class="button big previous">Previous</a><li><a title="Spring中的设计模式" href="/spring/2020/02/12/design-mode.html" class="button big next">Next</a><li id="/docker/2020/02/12/kubernetes.html" class="leancloud_visitors" style="float: right;"><a class="icon fa-eye leancloud-visitors-count" aria-hidden="true"></a></ul></div><script> new Valine({ el: '#vcomments' , appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc', notify:false, verify:false, avatar:'mp', placeholder: '若有疏失，還望指正', visitor: true, recordIP: true }); </script></div><div id="leftsead"><ul><li class="top"> ↑<li class="bottom"> ↑</ul></div><script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script> <script src="https://cdn.bootcss.com/skel/3.0.0/skel.min.js"></script> <script src="/assets/js/util.js"></script> <!--[if lte IE 8]><script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script><![endif]--> <script src="/assets/js/main.js"></script> <script src="/assets/js/search.js"></script> <script> new Valine({ el: '#vcomments', appId: 'VDYHbJKU0wCisABJmYCE1jaY-gzGzoHsz', appKey: '1CSpcPFQ88n8LBW7SjpAbMIc' }) </script>
